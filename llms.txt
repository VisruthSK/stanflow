# stanflow

``` R
          █████                            ██████  ████                          
         ░░███                            ███░░███░░███                          
  █████  ███████    ██████   ████████    ░███ ░░░  ░███   ██████  █████ ███ █████
 ███░░  ░░░███░    ░░░░░███ ░░███░░███  ███████    ░███  ███░░███░░███ ░███░░███ 
░░█████   ░███      ███████  ░███ ░███ ░░░███░     ░███ ░███ ░███ ░███ ░███ ░███ 
 ░░░░███  ░███ ███ ███░░███  ░███ ░███   ░███      ░███ ░███ ░███ ░░███████████  
 ██████   ░░█████ ░░████████ ████ █████  █████     █████░░██████   ░░████░████   
░░░░░░     ░░░░░   ░░░░░░░░ ░░░░ ░░░░░  ░░░░░     ░░░░░  ░░░░░░     ░░░░ ░░░░    
```

`stanflow` offers an integrated, mildly opinionated access to a
Stan-based [Bayesian Workflow](https://arxiv.org/abs/2011.01808) (Gelman
et al. 2020). Much like the famous [tidyverse
package](https://github.com/tidyverse/tidyverse), `stanflow` is a
metapackage which installs and attaches relevant Stan R packages,
serving as a one-stop-shop for Bayesian modelling.

`stanflow` draws heavy inspiration from the `tidyverse`, and reuses
portions of its codebase–however, `stanflow` eschews `tidyverse`
packages (i.e., `purrr`, `dplyr`, etc.) for base R implementations.

## Installation

You can install the development version of stanflow from
[GitHub](https://github.com/) with:

``` r
# install.packages("pak")
pak::pak("VisruthSK/stanflow")
```

## Usage

Here, we load `stanflow` and decide to use `cmdstanr` as the backend for
`brms`.

``` r
library(stanflow)
setup_interface(
  interface = "brms",
  dev = FALSE,
  prefer_cmdstanr = TRUE,
  quiet = FALSE,
  force = FALSE,
  skip_setup = FALSE
)
#> ℹ Adding cmdstanr to setup because `prefer_cmdstanr = TRUE`
#> ℹ Attaching brms...
#> ℹ Configured brms: set `options(mc.cores = parallel::detectCores())` and `options(brms.backend = 'cmdstanr')`
#> ℹ Attaching cmdstanr...
#> The C++ toolchain required for CmdStan is setup properly!
#> ℹ Found CmdStan v2.37.0 at 'C:/Users/visru/.cmdstan/cmdstan-2.37.0'
#> ✔ Setup complete. brms, cmdstanr are attached; you do not need to run `library()`.
set.seed(1234)
```

With these two commands (with the
[`setup_interface()`](https://visruthsk.github.io/stanflow/reference/setup_interface.md)
call being unnecessarily verbose), users have access to everything they
need to fit and interrogate Bayesian models. Specifically, those two
commands will load the core stanflow packages: `bayesplot`, `loo`,
`posterior`, `projpred` and `shinystan`, as well as setup `brms` to use
the `cmdstanr` backend with as many cores as are available on your
machine. These package (inlcuding `brms` and `cmdstanr`) are all
“[`library()`](https://rdrr.io/r/base/library.html)d” as well, so we can
proceed with our analysis immediately.

``` r
cmdstanr_example()
#>    variable   mean median   sd  mad     q5    q95 rhat ess_bulk ess_tail
#>  lp__       -66.02 -65.68 1.50 1.27 -68.96 -64.31 1.00     1723     2491
#>  alpha        0.38   0.38 0.22 0.22   0.02   0.74 1.00     4248     2403
#>  beta[1]     -0.66  -0.65 0.25 0.25  -1.07  -0.26 1.00     4006     2689
#>  beta[2]     -0.27  -0.27 0.23 0.23  -0.66   0.11 1.00     3799     2997
#>  beta[3]      0.68   0.67 0.27 0.27   0.24   1.14 1.00     4243     2892
#>  log_lik[1]  -0.52  -0.51 0.10 0.10  -0.69  -0.36 1.00     4343     2757
#>  log_lik[2]  -0.41  -0.39 0.15 0.15  -0.68  -0.19 1.00     4596     2817
#>  log_lik[3]  -0.50  -0.46 0.22 0.21  -0.91  -0.20 1.00     4308     3236
#>  log_lik[4]  -0.45  -0.44 0.15 0.15  -0.73  -0.23 1.00     3917     2693
#>  log_lik[5]  -1.19  -1.16 0.28 0.28  -1.68  -0.76 1.00     4649     2849
#> 
#>  # showing 10 of 105 rows (change via 'max_rows' argument or 'cmdstanr_max_rows' option)

fit1 <- brm(
  count ~ zAge + zBase * Trt + (1 | patient),
  data = epilepsy,
  family = poisson(),
  silent = TRUE,
  refresh = 0
)
#> Compiling Stan program...
#> Start sampling
summary(fit1)
#>  Family: poisson 
#>   Links: mu = log 
#> Formula: count ~ zAge + zBase * Trt + (1 | patient) 
#>    Data: epilepsy (Number of observations: 236) 
#>   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
#>          total post-warmup draws = 4000
#> 
#> Multilevel Hyperparameters:
#> ~patient (Number of levels: 59) 
#>               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
#> sd(Intercept)     0.58      0.07     0.47     0.73 1.00      763     1532
#> 
#> Regression Coefficients:
#>            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
#> Intercept      1.77      0.12     1.52     2.00 1.00      522     1071
#> zAge           0.09      0.09    -0.07     0.27 1.00      767     1503
#> zBase          0.71      0.12     0.47     0.93 1.00      703     1272
#> Trt1          -0.27      0.16    -0.59     0.06 1.00      639     1253
#> zBase:Trt1     0.05      0.16    -0.26     0.37 1.00      811     1721
#> 
#> Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
#> and Tail_ESS are effective sample size measures, and Rhat is the potential
#> scale reduction factor on split chains (at convergence, Rhat = 1).

plot(fit1, variable = c("b_Trt1", "b_zBase"))
```

![](reference/figures/README-unnamed-chunk-3-1.png)

``` r

fit2 <- brm(
  count ~ zAge + zBase * Trt + (1 | patient) + (1 | obs),
  data = epilepsy,
  family = poisson(),
  silent = TRUE,
  refresh = 0
)
#> Compiling Stan program...
#> Start sampling
summary(fit2)
#>  Family: poisson 
#>   Links: mu = log 
#> Formula: count ~ zAge + zBase * Trt + (1 | patient) + (1 | obs) 
#>    Data: epilepsy (Number of observations: 236) 
#>   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
#>          total post-warmup draws = 4000
#> 
#> Multilevel Hyperparameters:
#> ~obs (Number of levels: 236) 
#>               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
#> sd(Intercept)     0.37      0.04     0.29     0.46 1.00     1244     1988
#> 
#> ~patient (Number of levels: 59) 
#>               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
#> sd(Intercept)     0.54      0.08     0.41     0.71 1.00     1034     1887
#> 
#> Regression Coefficients:
#>            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
#> Intercept      1.72      0.12     1.48     1.96 1.00      977     1542
#> zAge           0.09      0.09    -0.08     0.26 1.00      972     1738
#> zBase          0.70      0.12     0.47     0.93 1.01      991     1542
#> Trt1          -0.26      0.17    -0.60     0.06 1.00     1098     1550
#> zBase:Trt1     0.06      0.16    -0.26     0.39 1.01     1032     1705
#> 
#> Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
#> and Tail_ESS are effective sample size measures, and Rhat is the potential
#> scale reduction factor on split chains (at convergence, Rhat = 1).

loo(fit1, fit2)
#> Warning: Found 9 observations with a pareto_k > 0.7 in model 'fit1'. We
#> recommend to set 'moment_match = TRUE' in order to perform moment matching for
#> problematic observations.
#> Warning: Found 61 observations with a pareto_k > 0.7 in model 'fit2'. We
#> recommend to set 'moment_match = TRUE' in order to perform moment matching for
#> problematic observations.
#> Output of model 'fit1':
#> 
#> Computed from 4000 by 236 log-likelihood matrix.
#> 
#>          Estimate   SE
#> elpd_loo   -672.5 37.2
#> p_loo        94.9 14.8
#> looic      1345.0 74.3
#> ------
#> MCSE of elpd_loo is NA.
#> MCSE and ESS estimates assume MCMC draws (r_eff in [0.4, 2.4]).
#> 
#> Pareto k diagnostic values:
#>                          Count Pct.    Min. ESS
#> (-Inf, 0.7]   (good)     227   96.2%   196     
#>    (0.7, 1]   (bad)        8    3.4%   <NA>    
#>    (1, Inf)   (very bad)   1    0.4%   <NA>    
#> See help('pareto-k-diagnostic') for details.
#> 
#> Output of model 'fit2':
#> 
#> Computed from 4000 by 236 log-likelihood matrix.
#> 
#>          Estimate   SE
#> elpd_loo   -595.4 14.1
#> p_loo       108.2  7.4
#> looic      1190.9 28.2
#> ------
#> MCSE of elpd_loo is NA.
#> MCSE and ESS estimates assume MCMC draws (r_eff in [0.4, 1.6]).
#> 
#> Pareto k diagnostic values:
#>                          Count Pct.    Min. ESS
#> (-Inf, 0.7]   (good)     175   74.2%   168     
#>    (0.7, 1]   (bad)       53   22.5%   <NA>    
#>    (1, Inf)   (very bad)   8    3.4%   <NA>    
#> See help('pareto-k-diagnostic') for details.
#> 
#> Model comparisons:
#>      elpd_diff se_diff
#> fit2   0.0       0.0  
#> fit1 -77.1      27.9
```

Code snippets above are taken from the [`brms`
README](https://paulbuerkner.com/brms/) but aren’t directly comparable.

# Package index

## All functions

- [`flow_check()`](https://visruthsk.github.io/stanflow/reference/flow_check.md)
  : Print stanflow status and conflicts
- [`setup_interface()`](https://visruthsk.github.io/stanflow/reference/setup_interface.md)
  : Setup and Load Stan Interfaces
- [`stan_logo()`](https://visruthsk.github.io/stanflow/reference/stan_logo.md)
  : Print the Stan ASCII art logo
- [`stanflow_conflicts()`](https://visruthsk.github.io/stanflow/reference/stanflow_conflicts.md)
  : Conflicts between stanflow and other packages
- [`stanflow_deps()`](https://visruthsk.github.io/stanflow/reference/stanflow_deps.md)
  : List all stanflow dependencies
- [`stanflow_logo()`](https://visruthsk.github.io/stanflow/reference/stanflow_logo.md)
  : Print the stanflow ASCII art logo
- [`stanflow_update()`](https://visruthsk.github.io/stanflow/reference/stanflow_update.md)
  : Update stanflow packages

